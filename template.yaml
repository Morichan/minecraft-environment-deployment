AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  SAM Template for Minecraft Environment Deployment


Parameters:
  ResourceTagKey:
    Type: String
    Description: Tag key to be associated with resources, almost identical to the key name auto-generated by SAM-CLI (difference is prefix `aws` to `minecraft`,) set AWS::StackName to value
    Default: minecraft:cloudformation:stack-name


Resources:
  # VPC
  MinecraftVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.10.0.0/24
      EnableDnsHostnames: true
  MinecraftVPCPublicSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref MinecraftVPC
      CidrBlock: 10.10.0.0/28
      MapPublicIpOnLaunch: true
      AvailabilityZone: !Select
      - 0
      - Fn::GetAZs: !Ref AWS::Region
  MinecraftVPCSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: For Minecraft server
      VpcId: !Ref MinecraftVPC
      SecurityGroupIngress:
      - IpProtocol: tcp
        FromPort: 25565
        ToPort: 25565
        CidrIp: 0.0.0.0/0
      - IpProtocol: udp
        FromPort: 25565
        ToPort: 25565
        CidrIp: 0.0.0.0/0
      SecurityGroupEgress:
      - IpProtocol: -1
        FromPort: -1
        ToPort: -1
        CidrIp: 0.0.0.0/0

  # IGW
  MinecraftVPCIGW:
    Type: AWS::EC2::InternetGateway
  MinecraftVPCIGWAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId: !Ref MinecraftVPCIGW
      VpcId: !Ref MinecraftVPC

  # RoutingTable
  MinecraftVPCRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref MinecraftVPC
  MinecraftVPCRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref MinecraftVPCRouteTable
      SubnetId: !Ref MinecraftVPCPublicSubnet
  MinecraftVPCRoute:
    Type: AWS::EC2::Route
    Properties:
      GatewayId: !Ref MinecraftVPCIGW
      RouteTableId: !Ref MinecraftVPCRouteTable
      DestinationCidrBlock: 0.0.0.0/0
